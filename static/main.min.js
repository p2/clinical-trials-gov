function initApp(){window!=window.top&&$("#back_to_patient").hide();loadDemographics();loadProblemList()}function loadDemographics(){$.ajax({url:"demographics",dataType:"json"}).always(function(e,t,n){var r="success"==t?e:"parsererror"==t?{}:null,i={};r?i=r:console.warn("No good response for demographics",e,n);$("#patient_overview").html(can.view("templates/patient_demographics.ejs",{demo:i}))})}function loadJSON(e,t,n){$.ajax({url:e,dataType:"json"}).always(function(r,i,s){if("success"==i)t?t(r,i,s):console.warn("Successfully loaded",e,"but no success func is set");else{console.error("ERROR loading URL:",e,"RETURNED",r,i,s);t&&n(r,i,s)}})}function sortedKeysFromDict(e){var t=[];for(var n in e)t[t.length]=n;t.sort();return t}function sortChildren(e,t,n){var r=e.children(t).get();r.sort(n);$.each(r,function(t,n){e.append(n)})}function text2html(e){if(!e)return"";var t=e.replace(/(^\s+)|(\s+$)/g,"");t=t.replace(/(\r\n|\n)/g,"<br />");return t}function newUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}function hasLocalStorage(){try{return"localStorage"in window&&window.localStorage!==null}catch(e){}return!1}function compareMedByNameASC(e,t){return"sp:drugName"in e?"dcterms:title"in e["sp:drugName"]?"sp:drugName"in t?"dcterms:title"in t["sp:drugName"]?e["sp:drugName"]["dcterms:title"]<t["sp:drugName"]["dcterms:title"]?-1:e["sp:drugName"]["dcterms:title"]>t["sp:drugName"]["dcterms:title"]?1:0:-1:-1:1:1}function compareProblemByNameASC(e,t){return"sp:problemName"in e?"dcterms:title"in e["sp:problemName"]?"sp:problemName"in t?"dcterms:title"in t["sp:problemName"]?e["sp:problemName"]["dcterms:title"]<t["sp:problemName"]["dcterms:title"]?-1:e["sp:problemName"]["dcterms:title"]>t["sp:problemName"]["dcterms:title"]?1:0:-1:-1:1:1}function compareByDateDESC(e,t){return"date"in e?"date"in t?parseInt(e.date)<parseInt(t.date)?1:parseInt(e.date)>parseInt(t.date)?-1:0:-1:1}function _geo_initMap(){if(g_map)return;var e={zoom:4,minZoom:3,maxZoom:15,center:new google.maps.LatLng(38.5,-96.5),mapTypeId:google.maps.MapTypeId.ROADMAP};g_map=new google.maps.Map($("#g_map").get(0),e);g_clusterer=new MarkerClusterer(g_map);g_clusterer.onClick=function(e){return _geo_multipleMarkersAtSameLocation(e.cluster_)};g_marker_green=new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|33CC22",new google.maps.Size(21,34),new google.maps.Point(0,0),new google.maps.Point(10,34));g_marker_red=new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2|AA2200",new google.maps.Size(21,34),new google.maps.Point(0,0),new google.maps.Point(10,34));g_patient_location&&_geo_zoomToPatient()}function geo_showMap(){var e=Math.max(300,Math.round($(window).height()*.4));$("#g_map").css("height",e+"px").show();g_map||_geo_initMap()}function geo_hideMap(){$("#g_map").hide();geo_unhighlightPin()}function geo_locatePatient(e,t){if(!e||0==e.length){g_patient_location=null;t&&t(!1,null,null);return}geo_codeAddress(e,function(e,n){g_patient_location=n;g_map&&n&&_geo_zoomToPatient();t&&t(e,n?n.lat():null,n?n.lng():null)})}function geo_codeAddress(e,t){if(!e){console.warn("No address given, cannot geo-code");t&&t(!1,null);return}g_geocoder||(g_geocoder=new google.maps.Geocoder);g_geocoder.geocode({address:e},function(n,r){var i=null;google.maps.GeocoderStatus.OK==r?i=n[0].geometry.location:google.maps.GeocoderStatus.ZERO_RESULTS?alert('The address "'+e+'" could not be located.'):console.error("Geocode failed: "+r);t&&t(i!=null,i)})}function geo_addPins(e,t,n){if(!e||0===e.length)return;var r=[];for(var i=0;i<e.length;i++){var s=e[i],o=new google.maps.Marker({position:new google.maps.LatLng(s.lat,s.lng),trial:s.trial,location:s.location,title:s.trial.title,icon:s.reason?g_marker_red:g_marker_green,animation:t?google.maps.Animation.DROP:null});r.push(o);n&&google.maps.event.addListener(o,"click",n)}g_clusterer.addMarkers(r)}function geo_highlightPin(e){if(!e){console.error("I need a pin to highlight");return}g_highlighted_pin&&g_highlighted_pin.setAnimation();e.setAnimation(google.maps.Animation.BOUNCE);g_highlighted_pin=e}function _geo_multipleMarkersAtSameLocation(e){if(e.getMarkers().length>1){var t=e.getMarkers();showTrialsforPins(t);return!1}return!0}function geo_unhighlightPin(){if(g_highlighted_pin){g_highlighted_pin.setAnimation();g_highlighted_pin=null}}function geo_zoomToPins(e){return;var t,o,u,a}function geo_clearAllPins(){for(var e=0;e<g_pins.length;e++)g_pins[e].setMap(null);g_pins=[];g_clusterer&&g_clusterer.clearMarkers()}function _geo_zoomToPatient(){if(!g_patient_location)return;if(!g_map){console.error("No map, cannot zoom to patient");return}g_patient_pin&&g_patient_pin.setMap(null);g_patient_pin=new google.maps.Marker({map:g_map,position:g_patient_location});g_map.setCenter(g_patient_location)}function kmDistanceBetweenLocationsLatLng(e,t,n,r){var i=6371,s=_geo_deg2rad(n-e),o=_geo_deg2rad(r-t),u=Math.sin(s/2)*Math.sin(s/2)+Math.cos(_geo_deg2rad(e))*Math.cos(_geo_deg2rad(n))*Math.sin(o/2)*Math.sin(o/2),a=2*Math.asin(Math.sqrt(u));return i*a}function kmDistanceBetweenLocations(e,t){return kmDistanceBetweenLocationsLatLng(e.lat(),e.lng(),t.lat(),t.lng())}function _geo_deg2rad(e){return e*(Math.PI/180)}function loadProblemList(){$.ajax({url:"problems",dataType:"json"}).always(function(e,t,n){var r="success"==t?e:"parsererror"==t?{}:null;if(r)$("#patient_problems").html(can.view("templates/patient_problems.ejs",{data:r,last_manual_input:_last_manual_input}));else{$("#patient_problems").text("Could not load the problem list, see the console for details");console.warn("No good response for problems",e,n)}})}function didClickProblem(e,t){var n=$("#"+e);if(!$("#"+e).is("*")){alert("Error, see Browser console");console.error('didClickProblem("'+e+'") -- no such problem_id');return}t||!n.hasClass("active")?hideProblemsAndStartTrialSearch(e):cancelTrialSearchAndShowProblemList(e)}function hideProblemsAndStartTrialSearch(e){var t="prob_manual"==e,n=$("#"+e).find("div.problem_name").text();t&&(n=$("#manual_problem").val());if(!n){$("#manual_problem").focus();return}var r=$("#"+e);r.addClass("active");$("#problem_list").find("li").each(function(t,n){e!=n.getAttribute("id")&&$(n).slideUp("fast")});if(!t){var i=$("#cancel_trials");i.is("*")||(i=$("<button/>",{type:"button",id:"cancel_trials"}).text("Cancel"));r.prepend(i)}else{$("#manual_cancel").show();$("#manual_submit").hide()}var s=$("#refresh_trials");s.is("*")||(s=$("<button/>",{type:"button",id:"refresh_trials"}).text("Refresh"));s.click(function(t){didClickProblem(e,!0);t.stopPropagation()});r.prepend(s);var o=$("#select_female").is(":checked")?"female":"male",u=1*$("#demo_age").val();t?searchTrialsByTerm(n,o,u,!0):searchTrialsByCondition(n,o,u,!1)}function cancelTrialSearchAndShowProblemList(e){cancelTrialSearch();var t=0;$("#problem_list").find("li").each(function(e,n){$(n).slideDown("fast");t++});$("#refresh_trials").remove();$("#cancel_trials").remove();$("#manual_cancel").hide();$("#manual_submit").show();e&&t>1&&$("#"+e).removeClass("active")}function _toggleTrialLocationContact(e){var t=$(e),n=t.siblings(".loc_contact");if(n.is(":visible"))n.fadeOut("fast");else{n.show();n.css("left",(t.outerWidth()-n.outerWidth())/2+t.position().left)}}function _toggleEligibilityCriteria(e){var t=$(e),n=t.closest(".trial"),r=n.find(".formatted_criteria").first();if(r.is(":visible")){r.hide();t.text("Show eligibility criteria")}else{r.show();t.text("Hide eligibility criteria")}}function searchTrialsByTerm(e,t,n,r){_trialSearchMustStop=!1;_initTrialSearch(e,null,t,n,r)}function searchTrialsByCondition(e,t,n,r){_trialSearchMustStop=!1;_initTrialSearch(null,e,t,n,r)}function cancelTrialSearch(){_trialSearchMustStop=!0;if(_trialSearchInterval){window.clearInterval(_trialSearchInterval);_trialSearchInterval=null}showTrialStatus();resetUI()}function resetUI(){$("#trial_selectors").find(".trial_selector").empty();$("#trial_selectors").find(".trial_opt_selector > ul").empty();$("#trial_selectors").hide();resetShownTrials();hideNoTrialsHint()}function resetShownTrials(){$("#trial_list").empty();showNoTrialsHint();cleanMap();geo_hideMap();$("#g_map_toggle").hide().find("a").text("Show Map")}function cleanMap(){_trial_locations=null;geo_clearAllPins();$("#selected_trial").empty().hide()}function _initTrialSearch(e,t,n,r,i){if(_trialSearchInterval){console.warn("Already searching");return}resetUI();_run_id=null;showTrialStatus("Starting...");geo_locatePatient($("#demo_location").val(),function(s,o,u){var a=s?o+","+u:null,f={gender:n,age:r,latlng:a,remember_input:i?!0:!1},l=e?e:t;f[e?"term":"cond"]=l;$.ajax({url:"trial_runs",data:f}).always(function(e,t,n){if(_trialSearchMustStop)return;if("success"==t){_run_id=e;_trialSearchInterval&&window.clearInterval(_trialSearchInterval);_trialSearchInterval=window.setInterval(function(){checkTrialStatus()},1e3)}else showTrialStatus("Error searching for trials: "+n)})})}function checkTrialStatus(){if(!_run_id)return;$.ajax({url:"trial_runs/"+_run_id+"/progress"}).always(function(e,t,n){if(_trialSearchMustStop)return;if("success"==t)if("done"==e){window.clearInterval(_trialSearchInterval);_trialSearchInterval=null;showTrialStatus("Filtering by demographics...");_filterTrialsByDemographics(_run_id)}else{if(e&&e.length>5&&e.match(/^error/i)){window.clearInterval(_trialSearchInterval);_trialSearchInterval=null}showTrialStatus(e)}else{console.error(e,t,n);showTrialStatus("Error checking trial status: "+n);window.clearInterval(_trialSearchInterval);_trialSearchInterval=null}})}function _filterTrialsByDemographics(e){loadJSON("trial_runs/"+e+"/filter/demographics",function(t,n,r){showTrialStatus("Filtering by problem list...");_filterTrialsByProblems(e)},function(e,t,n){showTrialStatus("Error filtering trials (demographics): "+n)})}function _filterTrialsByProblems(e){loadJSON("trial_runs/"+e+"/filter/problems",function(t,n,r){loadTrialOverview(e)},function(e,t,n){showTrialStatus("Error filtering trials (problems): "+n)})}function loadTrialOverview(e){loadJSON("trial_runs/"+e+"/overview",function(e,t,n){if("intervention_types"in e&&"drug_phases"in e){_fillInterventionTypes(e.intervention_types);_fillTrialPhases(e.drug_phases);showTrialStatus();showNoTrialsHint();$("#trial_selectors").show()}else console.error("Malformed response:",e)},function(e,t,n){showTrialStatus("Error retrieving overview data: "+n)})}function _fillInterventionTypes(e){if(e){var t=$("#selector_inv_type"),n=sortedKeysFromDict(e);for(var r=0;r<n.length;r++){var i=n[r],s=_getOptCheckElement(i,0,!1);s.data("intervention-type",i);t.append(s);s.find(".num_matches").text(e[i])}sortChildren(t,"li",function(e,t){return $(e).text().toLowerCase().localeCompare($(t).text().toLowerCase())})}}function _fillTrialPhases(e){if(e){var t=$("#selector_inv_phase"),n=sortedKeysFromDict(e);for(var r=0;r<n.length;r++){var i=n[r],s=_getOptCheckElement(i,0,!0);s.data("phase",i);t.append(s);s.find(".num_matches").text(e[i])}n.length>0&&sortChildren(t,"li",function(e,t){return $(e).text().toLowerCase().localeCompare($(t).text().toLowerCase())})}}function _getOptRadioElement(e,t,n){var r=$("<li/>",{href:"javascript:void(0)"}),i=newUUID(),s=$("<input/>",{id:i,type:"radio",name:"ugly_hack"});s.change(_toggleShowGoodTrials);r.append(s);r.append($("<label/>",{"for":i}).text(e));r.append($("<span/>").addClass("num_matches").text(t));if(n){r.addClass("active");s.prop("checked",!0)}return r}function _getOptCheckElement(e,t,n){var r=$("<li/>",{href:"javascript:void(0)"}),i=newUUID(),s=$("<input/>",{id:i,type:"checkbox"});r.append(s);r.append($("<label/>",{"for":i}).text(e));r.append($("<span/>").addClass("num_matches").text(t));s.change(_toggleOptCheckElement);if(n){r.addClass("active");s.prop("checked",!0)}return r}function _toggleShowGoodTrials(e){_showGoodTrials=!_showGoodTrials;updateShownHiddenTrials()}function _toggleOptCheckElement(e){var t=$(this).parent();t.find("input").prop("checked")?t.addClass("active"):t.removeClass("active");updateShownHiddenTrials()}function _toggleKeyword(e){alert("not implemented");var t=$(e).text(),n=_normalizeKeyword(t),r=$(e).parent().data("trial-nct"),i=$(e).offset().top,s=$(window).scrollTop(),o=$("#selector_keywords"),u=!1,a=0;o.children("span").each(function(e){if(n==$(this).data("normalized")){u=!0;$(this).remove()}else a++});if(!u){var f=$("<span/>").addClass("tag").addClass("active").data("normalized",n).text(t).click(function(e){_toggleKeyword(this)});o.append(f).parent().show()}else 0==a&&o.parent().hide();updateShownHiddenTrials();if(i>0){i-=144;var l=null;$("#trial_list").children().each(function(e){var t=$(this).find(".trial").data("trial");if(t&&t.nct==r){l=$(this);return!1}});if(l){var c=l.offset().top-(i-s);$(window).scrollTop(c)}}}function _normalizeKeyword(e){return e?e.toLowerCase():null}function updateShownHiddenTrials(){if(!_run_id){showTrialStatus("I have lost track of our run, please search again");return}$("#trial_selectors").find('input[type="checkbox"]').prop("disabled",!0);cleanMap();var e=[],t=[];$("#selector_inv_type").children("li").each(function(e,n){var r=$(n);r.hasClass("active")&&t.push(r.data("intervention-type"))});t.length>0&&e.push("intv="+t.join("|"));var n=[],r=[];$("#selector_inv_phase").children("li").each(function(e,t){var i=$(t);n.push(i);i.hasClass("active")&&r.push(i.data("phase"))});r.length>0?r.length<n.length&&e.push("phases="+r.join("|")):$(n).each(function(e,t){t.find("input").prop("checked",!0);t.addClass("active")});n.length>0&&t.length>0?$("#selector_inv_phase_parent").show():$("#selector_inv_phase_parent").hide();var i=[];$("#selector_keywords").children("span").each(function(e,t){i.push($(t).data("normalized"))});if(0==t.length&&0==i.length){resetShownTrials();return}var s=e.join("&");loadJSON("trial_runs/"+_run_id+"/trials?"+s,function(e,t,n){_showTrials(e,0);$("#trial_selectors").find('input[type="checkbox"]').prop("disabled",!1);window.setTimeout(geo_zoomToPins,100)},function(e,t,n){showTrialStatus("Error loading trials: "+n);$("#trial_selectors").find('input[type="checkbox"]').prop("disabled",!1)})}function _showTrials(e,t){var n=$("#trial_list");(!t||0==t)&&n.empty();$("#show_more_trials").remove();$("#g_map_toggle").show();if(!e||0==e.length||t>=e.length){e.length>0&&t>=e.length&&console.warn("Cannot show trials starting at: ",t,"trials: ",e);if(!e||0==e.length){$("#g_map_toggle > span").text("");showNoTrialsHint()}return}var r=[];$("#selector_keywords").children("span").each(function(e,t){r.push($(t).data("normalized"))});var i=t+_trialsPerPage;e.length>i&&e.length<t+_trialsPerPage+_trialsPerPage/10&&(i=e.length+t);var s=!1,o=$("#g_map");_trial_locations||(_trial_locations=[]);for(var u=t;u<e.length;u++){var a=new Trial(e[u]);_trial_locations.push.apply(_trial_locations,a.locationPins());if(u<i){var f=$("<li/>").append(can.view("templates/trial_item.ejs",{trial:a,active_keywords:r}));n.append(f);a.showClosestLocations(g_patient_location,f,0,3)}else s=!0}$("#g_map_toggle > span").text(_trial_locations.length>1e3?" ("+_trial_locations.length+" trial locations)":"");hideNoTrialsHint();if(s){var l=e.length-i,f=$("<li/>",{id:"show_more_trials"}).append("<h1>There are "+l+" more trials</h1>"),c=$("<a/>",{href:"javascript:void(0);"}).text("Show "+(_trialsPerPage<l?_trialsPerPage+" more":"all")).click(function(n){_showTrials(e,t+_trialsPerPage)});f.append($("<h1/>").append(c));n.append(f)}}function toggleTrialMap(){var e=$("#g_map");if(e.is(":visible")){var t=$("#g_map_toggle").offset().top-$(window).scrollTop();geo_hideMap();$("#g_map_toggle > a").text("Show Map");$("#selected_trial").empty().hide();var n=$("#g_map_toggle").offset().top-$(window).scrollTop();Math.abs(t-n)>50&&$(window).scrollTop(Math.max(0,$("#g_map_toggle").offset().top-t))}else{geo_showMap();$("#g_map_toggle > a").text("Hide Map");window.setTimeout(function(){geo_addPins(_trial_locations,!1,function(e){showTrialsforPins([this])});geo_zoomToPins()},200)}}function showTrialsforPins(e){1==e.length&&geo_highlightPin(e[0]);var t=$("#g_map").offset().top-$(window).scrollTop(),n=$("#selected_trial").empty().show();for(var r=0;r<e.length;r++){var i=e[r],s=$("<li/>").append(can.view("templates/trial_item.ejs",{trial:i.trial,active_keywords:null}));s.append('<a class="dismiss_link" href="javascript:void(0);" onclick="dismissShownTrial(this)">dismiss</a>');n.append(s);i.trial.showLocation(s,i.location)}var o=$("#g_map").offset().top-$(window).scrollTop();Math.abs(o-t)>50&&$(window).scrollTop(Math.max(200,$("#g_map").offset().top-t))}function dismissShownTrial(e){var t=$(e).closest("li").slideUp("fast",function(){$(this).remove();var e=$("#selected_trial");0==e.find("li").length&&e.hide()});geo_unhighlightPin()}function showTrialStatus(e){var t=$("#trial_status");if(!e){t.hide();return}t.show().text(e)}function showNoTrialsHint(){var e=$("#no_trials_hint");e.is("*")||(e=$("<h3/>",{id:"no_trials_hint"}));var t=!1;$("#selector_inv_type").children("li").each(function(e,n){if($(n).find("input").prop("checked")){t=!0;return!1}});if(t){var n=!1;$("#selector_inv_phase").is(":visible")&&$("#selector_inv_phase").children("li").each(function(e,t){if($(t).find("input").prop("checked")){n=!0;return!1}});n?e.text("It seems no trials match your criteria"):e.text("Please select at least one trial phase")}else e.text("Please select at least one intervention or observation");$("#trials").append(e)}function hideNoTrialsHint(){$("#no_trials_hint").remove()}Array.prototype.contains=function(e){return this.indexOf(e)>=0};"indexOf"in Array.prototype||(Array.prototype.indexOf=function(e){for(var t=0;t<this.length;t++)if(this[t]==e)return t;return-1});Array.prototype.uniqueArray=function(){var e={},t=[];for(var n=0,r=this.length;n<r;++n){if(e.hasOwnProperty(this[n]))continue;t.push(this[n]);e[this[n]]=1}return t};Array.prototype.intersects=function(e){for(var t=0;t<this.length;t++)for(var n=0;n<e.length;n++)if(this[t]===e[n])return!0;return!1};window.console||function(){var e=["log","debug","info","warn","error","assert","dir","dirxml","group","groupEnd","time","timeEnd","count","trace","profile","profileEnd"],t=e.length;window.console={};for(var n=0;n<t;n++)window.console[e[n]]=function(){}}();var g_map=null,g_geocoder=null,g_clusterer=null,g_pins=[],g_highlighted_pin=null,g_patient_pin=null,g_patient_location=null,g_marker_green=null,g_marker_red=null;MarkerClusterer.prototype.onClick=function(){return!0};var TrialLocation=can.Construct({},{distance:null,init:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},kmDistanceTo:function(e){if(e&&"geodata"in this)this.distance=kmDistanceBetweenLocationsLatLng(e.lat(),e.lng(),this.geodata.latitude,this.geodata.longitude);else if(e){console.warn("No geodata for trial location: ",this);this.distance=null}return this.distance}}),Trial=can.Construct({geocode:function(e,t){for(var n=0;n<e.length;n++)e[n].geocode(t)}},{reason:null,intervention_types:null,trial_phases:null,trial_locations:null,did_add_pins:!1,last_loc_distances:null,closest:null,init:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},interventionTypes:function(){if(null==this.intervention_types){var e=[];if("intervention"in this&&this.intervention){for(var t=0;t<this.intervention.length;t++)"intervention_type"in this.intervention[t]&&e.push(this.intervention[t].intervention_type);e=e.uniqueArray()}e.length<1&&(e=["Observational"]);this.intervention_types=e}return this.intervention_types},trialPhases:function(){if(null==this.trial_phases){if(!1 in this||!this.phase)this.phase="N/A";var e=["N/A"];"N/A"!=this.phase&&(e=this.phase.split("/"));this.trial_phases=e}return this.trial_phases},locations:function(){if(null===this.trial_locations&&"location"in this&&this.location){var e=[];for(var t=0;t<this.location.length;t++){var n=this.location[t],r="formatted"in n.geodata&&n.geodata.formatted&&n.geodata.formatted.length>0?n.geodata.formatted.split(/,\s+/):["Unknown"],i=r.pop(),s=n.status?n.status.match(/recruiting/i):null,o=n.status?n.status.match(/not\s+[\w\s]*\s+recruiting/i):null,u="contact"in n&&n.contact?n.contact:null;if(!u||(!("email"in u)||!u.email)&&(!("phone"in u)||!u.phone))u="contact_backup"in n&&n.contact_backup?n.contact_backup:null;if(!u||(!("email"in u)||!u.email)&&(!("phone"in u)||!u.phone))u="overall_contact"in this?this.overall_contact:null;var a={trial:this,name:"facility"in n&&n.facility.name?n.facility.name:"",city:r.length>0?r.join(", "):"",country:i,geodata:"geodata"in n?n.geodata:null,status:n.status,status_color:o?"orange":s?"green":"red",contact:u};e.push(new TrialLocation(a))}this.trial_locations=e}return this.trial_locations},locationsByDistance:function(e){if(!e&&null!==this.last_loc_distances)return this.last_loc_distances;var t=[],n=this.locations();if(n){for(var r=0;r<n.length;r++){var i=n[r];t.push([i.kmDistanceTo(e),i])}t.sort(function(e,t){return e[0]-t[0]});this.last_loc_distances=t}return t},geocode:function(e){var t=this.locationsByDistance(e),n=t&&t.length>0?t[0]:[99999,null];this.closest=n[0]},showClosestLocations:function(e,t,n,r,i){var s=t.find(".trial_locations"),o=this.locations();if(o&&o.length>0){s.find(".show_more_locations").remove();var u=Math.min(o.length-n,r);o.length-n-u<3&&(u=o.length-n);u+=n;var a=n;for(;a<u;a++){var f=o[a],l=can.view("templates/trial_location.ejs",{loc:f});s.append(l)}if(a<o.length){var c=this,h=10,p=o.length-a-h<3?o.length-a:h,d=$("<a/>",{href:"javascript:void(0)"}).text("Show "+(p<o.length-a?"next "+p:" all")).click(function(n){c?c.showClosestLocations(e,t,a,p,!0):console.error("The trial object is undefined")}),v=$("<div/>").addClass("trial_location").addClass("show_more_locations"),m=$("<h3/>").html("There are "+(o.length-a)+" more locations<br />");m.append(d);v.append(m);if(i){v.hide();s.append(v);v.fadeIn("fast")}else s.append(v)}}else{var v=$('<div class="trial_location"><h3>No trial locations available</h3></div>');s.append(v)}},showLocation:function(e,t){var n=can.view("templates/trial_location.ejs",{loc:t});e.find(".trial_locations").append(n)},locationPins:function(){var e=this.locations(),t=[];if(e&&e.length>0)for(var n=0;n<e.length;n++)if("geodata"in e[n]){var r={lat:e[n].geodata.latitude,lng:e[n].geodata.longitude,location:e[n],trial:this};t.push(r)}return t}}),_trialSearchInterval=null,_trialSearchMustStop=!1,_trialBatchSize=10,_trialNumExpected=0,_trialNumDone=0,_showGoodTrials=!0,_trialsPerPage=50,_run_id=null,_trial_locations=null;