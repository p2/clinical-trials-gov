function initApp(){window!=window.top&&$("#back_to_patient_select").hide();loadDemographics();loadProblemList()}function loadDemographics(){$.ajax({url:"demographics",dataType:"json"}).always(function(e,t,n){var r="success"==t?e:"parsererror"==t?{}:null,i={};r?i=r:console.warn("No good response for demographics",e,n);$("#patient_overview").html("templates/patient_demographics.ejs",{demo:i})})}function loadProblemList(){$.ajax({url:"problems",dataType:"json"}).always(function(e,t,n){var r="success"==t?e:"parsererror"==t?{}:null;if(r)$("#patient_problems").html("templates/patient_problems.ejs",{data:r});else{$("#patient_problems").text("Could not load the problem list, see the console for details");console.warn("No good response for problems",e,n)}})}function didClickProblem(e,t){var n=$("#problem_list"),r=$("#"+e);if(!r.is("*")){alert("Error");return}if(t||!r.hasClass("active")){var i="prob_manual"==e;r.addClass("active");n.find("li").each(function(t,n){e!=n.getAttribute("id")&&$(n).slideUp("fast")});if(!i){var s=$("#cancel_trials");s.is("*")||(s=$("<button/>",{type:"clear",id:"cancel_trials"}).text("Cancel"));r.prepend(s)}var o=$("#refresh_trials");o.is("*")||(o=$("<button/>",{type:"button",id:"refresh_trials"}).text("Refresh"));o.click(function(t){didClickProblem(e,!0);t.stopPropagation()});r.prepend(o);var u=$("#"+e).find("div.problem_name").text();if(i){u=$("#manual_problem").val();$("#manual_submit").text("Cancel")}if(!u){u="diabetic cardiomyopathy";$("#manual_problem").val(u)}var a=$("#select_female").is(":checked")?"female":"male",f=1*$("#demo_age").val();searchTrials(u,a,f)}else{n.find("li").each(function(e,t){$(t).slideDown("fast")});if("prob_manual"==e){$("#manual_problem").val("");$("#manual_submit").text("Go")}$("#refresh_trials").remove();$("#cancel_trials").remove();r.removeClass("active");$("#selected_trial").empty();$("#trials").empty();clearAllPins();hideMap()}}function sortChildren(e,t,n){var r=e.children(t).get();r.sort(n);$.each(r,function(t,n){e.append(n)})}function text2html(e){if(!e)return"";var t=e.replace(/(^\s+)|(\s+$)/g,"");t=t.replace(/(\r\n|\n)/g,"<br />");return t}function compareMedByNameASC(e,t){return"sp:drugName"in e?"dcterms:title"in e["sp:drugName"]?"sp:drugName"in t?"dcterms:title"in t["sp:drugName"]?e["sp:drugName"]["dcterms:title"]<t["sp:drugName"]["dcterms:title"]?-1:e["sp:drugName"]["dcterms:title"]>t["sp:drugName"]["dcterms:title"]?1:0:-1:-1:1:1}function compareProblemByNameASC(e,t){return"sp:problemName"in e?"dcterms:title"in e["sp:problemName"]?"sp:problemName"in t?"dcterms:title"in t["sp:problemName"]?e["sp:problemName"]["dcterms:title"]<t["sp:problemName"]["dcterms:title"]?-1:e["sp:problemName"]["dcterms:title"]>t["sp:problemName"]["dcterms:title"]?1:0:-1:-1:1:1}function compareByDateDESC(e,t){return"date"in e?"date"in t?parseInt(e.date)<parseInt(t.date)?1:parseInt(e.date)>parseInt(t.date)?-1:0:-1:1}function searchTrials(e,t,n){_initTrialSearch(e,t,n)}function _initTrialSearch(e,t,n){if(_trialSearchInterval){console.warn("Already searching");return}clearAllPins();_showTrialStatus("Starting...");$.ajax({url:"trial_runs",data:{cond:e,gender:t,age:n}}).always(function(e,t,n){if("success"==t){_trialSearchInterval&&window.clearInterval(_trialSearchInterval);_trialSearchInterval=window.setInterval(function(){_checkTrialStatus(e)},1e3)}else{console.error(e," -- ",t," -- ",n);_showTrialStatus("Error, see console")}})}function _checkTrialStatus(e){$.ajax({url:"trial_runs/"+e+"/progress"}).always(function(t,n,r){if("success"==n)if("done"==t){window.clearInterval(_trialSearchInterval);_trialSearchInterval=null;_showTrialStatus("Retrieving results...");_getTrialResults(e)}else{if(t&&t.length>5&&t.match(/^error/i)){window.clearInterval(_trialSearchInterval);_trialSearchInterval=null}_showTrialStatus(t)}else{console.error(t,n,r);_showTrialStatus("Error checking trial status, see console");window.clearInterval(_trialSearchInterval);_trialSearchInterval=null}})}function _getTrialResults(e){$.ajax({url:"trial_runs/"+e+"/results",dataType:"json"}).always(function(t,n,r){if("success"==n){_showTrialStatus("Found "+t.length+" trials, filtering by demographics...");_filterTrialsByDemographics(e)}else{console.error(t,n,r);_showTrialStatus("Error getting trial results, see console")}})}function _filterTrialsByDemographics(e){$.ajax({url:"trial_runs/"+e+"/filter/demographics",dataType:"json"}).always(function(t,n,r){if("success"==n){_showTrialStatus("Filtering by problem list...");_filterTrialsByProblems(e)}else{console.error(t,n,r);_showTrialStatus("Error filtering trials (demographics), see console")}})}function _filterTrialsByProblems(e){$.ajax({url:"trial_runs/"+e+"/filter/problems",dataType:"json"}).always(function(e,t,n){if("success"==t)loadTrialsAfterLocatingPatient(e);else{console.error(e,t,n);_showTrialStatus("Error filtering trials (problems), see console")}})}function loadTrialsAfterLocatingPatient(e){locatePatient(function(t,n){if(t)_patient_loc=n;else{console.warn("Failed to locate the patient");_patient_loc=null}_loadTrials(e)})}function _loadTrials(e){var t=$("#trials"),n=$("<div/>",{id:"trial_loader"}).text("Loading trials...");t.empty().append(n);var r=0,i=0,s=$("<div/>",{id:"selector_goodbad"}).addClass("trial_opt_selector"),o=$("<div/>",{id:"selector_location"}).addClass("trial_opt_selector"),u=$("<div/>",{id:"selector_inv_type"}).addClass("trial_opt_selector"),a=$("<ul/>",{id:"trial_list"}).addClass("trial_list");for(var f=0;f<e.length;f++){var l=e[f],c=l[0],h=null;if(l.length>1){h=l[1];h&&i++}else r++;$.ajax({url:"trials/"+c,dataType:"json",context:{reason:h}}).always(function(e,t,n){if("success"==t){e.reason=this.reason;if("location"in e){var r=[];for(var i=0;i<e.location.length;i++)if("geodata"in e.location[i]){var s=e.location[i].geodata.latitude,o=e.location[i].geodata.longitude;if(_patient_loc){var f=kmDistanceBetweenLocations(_patient_loc,e.location[i].geodata);r.push(f);e.location[i].distance=f}else console.warn("Patient location is not yet available");var l=addPinToMap(s,o,e.title,this.reason?"AA2200":"33CC22");google.maps.event.addListener(l,"click",function(t){highlightPin(this);$("#selected_trial").html("templates/trial_item.ejs",{trial:e}).children(":first").addClass("active")})}else console.warn("No geodata for trial location: ",e.location[i]);if(r.length>0){r.sort(function(e,t){return e-t});e.closest=r[0]}}else console.warn("No geodata for trial "+c);var h=[];if("intervention"in e){for(var i=0;i<e.intervention.length;i++)"intervention_type"in e.intervention[i]&&h.push(e.intervention[i].intervention_type);h=h.uniqueArray()}h.length<1&&(h=["N/A"]);var p=$.map(u.children("a"),function(t){var n=$(t).data("intervention-type");if(!e.reason&&h.contains(n)){var r=$(t).find(".num_matches");r.text(r.text()*1+1)}return n});for(var d=0;d<h.length;d++){var v=h[d];if(!p.contains(v)){var m=_getOptTabElement(v,e.reason?0:1,_toggleInterventionType);m.data("intervention-type",v);u.append(m)}}sortChildren(u,"a",function(e,t){return $(e).text().toLowerCase().localeCompare($(t).text().toLowerCase())});$("#trial_loader").remove();var g=$("<li/>").html("templates/trial_item.ejs",{trial:e});g.hide();g.data("good",!this.reason);g.data("distance",e.closest);g.data("intervention-types",h);a.append(g);sortChildren(a,"li",function(e,t){return $(e).data("distance")-$(t).data("distance")})}else console.error(e,t,n)})}_showGoodTrials=!0;var p=_getOptTabElement("Potential Trials",r+" of "+e.length,_toggleShowGoodTrials);p.addClass("active");p.data("is-good",!0);s.append(p);var d=_getOptTabElement("Ineligible Trials",i+" of "+e.length,_toggleShowGoodTrials);d.data("is-good",!1);s.append(d);t.append(s);t.append(o);t.append(u);t.append(a)}function _showTrialStatus(e){$("#trials").empty().text(e)}function _getOptTabElement(e,t,n){var r=$("<a/>",{href:"javascript:void(0)"});r.append($("<span/>").text(e));r.append($("<span/>").addClass("num_matches").text(t));n&&r.click(n);return r}function _toggleShowGoodTrials(e){_showGoodTrials=!_showGoodTrials;_updateShownHiddenTrials()}function _toggleInterventionType(e){var t=$(this).data("intervention-type");if(!t){console.error("No type supplied to _toggleInterventionType()");return}var n=_activeInterventionTypes.indexOf(t);n>=0?_activeInterventionTypes.splice(n,1):_activeInterventionTypes.push(t);_updateShownHiddenTrials()}function _updateShownHiddenTrials(){var e={};$("#trial_list").children("li").each(function(t,n){var r=$(n),i=_showGoodTrials==r.data("good");if(i){var s=r.data("intervention-types");i=_activeInterventionTypes.intersects(s);for(var o=0;o<s.length;o++)s[o]in e?e[s[o]]++:e[s[o]]=1}i?r.slideDown("fast"):r.slideUp("fast")});$("#selector_goodbad").children("a").each(function(e,t){var n=$(t);n.removeClass("active");_showGoodTrials==n.data("is-good")&&n.addClass("active")});$("#selector_inv_type").children("a").each(function(t,n){var r=$(n),i=r.data("intervention-type");r.find(".num_matches").text(i in e?e[i]:0);r.removeClass("active");_activeInterventionTypes.contains(i)&&r.addClass("active")})}function locatePatient(e){var t=$("#demo_location").val();if(t){geocodeAddress(t,e);return}console.warn("Cannot locate patient, no address given");e&&e(!1,null)}function showMap(){$("#g_map").show()}function hideMap(){$("#g_map").hide()}function geocodeAddress(e,t){if(!e){console.error("No address given, cannot geo-code");t&&t(!1,null);return}g_geocoder||(g_geocoder=new google.maps.Geocoder);if(!g_map){var n={zoom:4,center:new google.maps.LatLng(38.5,-96.5),mapTypeId:google.maps.MapTypeId.ROADMAP};g_map=new google.maps.Map($("#g_map").get(0),n)}g_geocoder.geocode({address:e},function(n,r){var i=null;if(google.maps.GeocoderStatus.OK==r){i={latitude:n[0].geometry.location.jb,longitude:n[0].geometry.location.kb};g_map.setCenter(n[0].geometry.location);var s=new google.maps.Marker({map:g_map,position:n[0].geometry.location})}else google.maps.GeocoderStatus.ZERO_RESULTS?alert('The address "'+e+'" could not be located.'):console.error("Geocode failed: "+r);t&&t(i!=null,i)})}function addPinToMap(e,t,n,r){if(!e||!t){console.error("I need lat and long to place a pin");return}var i=new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2"+(r?"|"+r:""),new google.maps.Size(21,34),new google.maps.Point(0,0),new google.maps.Point(10,34)),s=new google.maps.Marker({map:g_map,position:new google.maps.LatLng(e,t),title:n,icon:i});g_pins.push(s);return s}function highlightPin(e){if(!e){console.error("I need a pin to highlight");return}g_highlighted_pin&&g_highlighted_pin.setAnimation();e.setAnimation(google.maps.Animation.BOUNCE);g_highlighted_pin=e}function clearAllPins(){for(var e=0;e<g_pins.length;e++)g_pins[e].setMap(null);g_pins=[]}function kmDistanceBetweenLocations(e,t){var n=6371,r=deg2rad(t.latitude-e.latitude),i=deg2rad(t.longitude-e.longitude),s=Math.sin(r/2)*Math.sin(r/2)+Math.cos(deg2rad(e.latitude))*Math.cos(deg2rad(t.latitude))*Math.sin(i/2)*Math.sin(i/2),o=2*Math.asin(Math.sqrt(s));return n*o}function deg2rad(e){return e*(Math.PI/180)}var _ruleCtrl=null,_reportCtrl=null;Array.prototype.contains=function(e){return this.indexOf(e)>=0};Array.prototype.indexOf=function(e){for(var t=0;t<this.length;t++)if(this[t]==e)return t;return-1};Array.prototype.uniqueArray=function(){var e={},t=[];for(var n=0,r=this.length;n<r;++n){if(e.hasOwnProperty(this[n]))continue;t.push(this[n]);e[this[n]]=1}return t};Array.prototype.intersects=function(e){for(var t=0;t<this.length;t++)for(var n=0;n<e.length;n++)if(this[t]===e[n])return!0;return!1};window.console||function(){var e=["log","debug","info","warn","error","assert","dir","dirxml","group","groupEnd","time","timeEnd","count","trace","profile","profileEnd"],t=e.length;window.console={};for(var n=0;n<t;n++)window.console[e[n]]=function(){}}();var _patient_loc=null,_trialSearchInterval=null,_showGoodTrials=!0,_activeInterventionTypes=[],g_map=null,g_geocoder=null,g_pins=[],g_highlighted_pin=null;