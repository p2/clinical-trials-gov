function initApp(){window!=window.top&&$("#back_to_patient_select").hide();loadDemographics();loadProblemList()}function loadDemographics(){$.ajax({url:"demographics",dataType:"json"}).always(function(e,t,n){var r="success"==t?e:"parsererror"==t?{}:null,i={};r?i=r:console.warn("No good response for demographics",e,n);$("#patient_overview").html("templates/patient_demographics.ejs",{demo:i})})}function loadProblemList(){$.ajax({url:"problems",dataType:"json"}).always(function(e,t,n){var r="success"==t?e:"parsererror"==t?{}:null;if(r)$("#patient_problems").html("templates/patient_problems.ejs",{data:r});else{$("#patient_problems").text("Could not load the problem list, see the console for details");console.warn("No good response for problems",e,n)}})}function didClickProblem(e){var t=$("#problem_list"),n=$("#"+e);if(!n.is("*")){alert("Error");return}if(!n.hasClass("active")){n.addClass("active");$("#select_prompt").text("Showing trials pertaining to:");t.find("li").each(function(t,n){e!=n.getAttribute("id")&&$(n).slideUp("fast")});var r=$("#"+e).find("div.bigger").text();r||(r="diabetic cardiomyopathy");_initTrialSearch(r)}else{t.find("li").each(function(e,t){$(t).slideDown("fast")});n.removeClass("active");$("#select_prompt").text("Choose for which problem to find trials:");$("#trials").empty()}}function _initTrialSearch(e){if(_trialSearchInterval){console.warn("Already searching");return}_showTrialStatus("Starting...");$.ajax({url:"trial_runs",data:{cond:e}}).always(function(e,t,n){if("success"==t)_trialSearchInterval=window.setInterval(function(){_checkTrialStatus(e)},1e3);else{console.error(e," -- ",t," -- ",n);_showTrialStatus("Error, see console")}})}function _checkTrialStatus(e){$.ajax({url:"trial_runs/"+e+"/progress"}).always(function(t,n,r){if("success"==n)if("done"==t){window.clearInterval(_trialSearchInterval);_trialSearchInterval=null;_showTrialStatus("Retrieving results...");_getTrialResults(e)}else{if(t&&t.length>5&&t.match(/^error/i)){window.clearInterval(_trialSearchInterval);_trialSearchInterval=null}_showTrialStatus(t)}else{console.error(t,n,r);_showTrialStatus("Error checking trial status, see console");window.clearInterval(_trialSearchInterval);_trialSearchInterval=null}})}function _getTrialResults(e){$.ajax({url:"trial_runs/"+e+"/results",dataType:"json"}).always(function(t,n,r){if("success"==n){_showTrialStatus("Found "+t.length+" trials, filtering by demographics...");_filterTrialsByDemographics(e)}else{console.error(t,n,r);_showTrialStatus("Error getting trial results, see console")}})}function _filterTrialsByDemographics(e){$.ajax({url:"trial_runs/"+e+"/filter/demographics",dataType:"json"}).always(function(t,n,r){if("success"==n){_showTrialStatus("Filtering by problem list...");_filterTrialsByProblems(e)}else{console.error(t,n,r);_showTrialStatus("Error filtering trials (demographics), see console")}})}function _filterTrialsByProblems(e){$.ajax({url:"trial_runs/"+e+"/filter/problems",dataType:"json"}).always(function(e,t,n){if("success"==t){_showTrialStatus();_loadTrials(e)}else{console.error(e,t,n);_showTrialStatus("Error filtering trials (problems), see console")}})}function _loadTrials(e){var t=$("#trials"),n=$("<div/>",{id:"trial_loader"}).text("Loading trials..."),r=$("<ul/>",{id:"trials_good"}),i=$("<ul/>",{id:"trials_bad"});t.append(n);t.append("<h3>Matching Trials</h3>");t.append(r);t.append("<h3>Filtered Trials</h3>");t.append(i);for(var s=0;s<e.length;s++){var o=e[s],u=o[0],a=null;o.length>0&&(a=o[1]);$.ajax({url:"trials/"+u,dataType:"json",context:{reason:a}}).always(function(e,t,s){if("success"==t){if(n){n.remove();n=null}var o=$("<li/>",{id:e.nct}),u=$("<div/>").hide().html(text2html(e.criteria.formatted));u.addClass("formatted_criteria");var a=$("<a/>",{href:"javascript:void(0)"});a.click(function(){u.toggle()});a.text(e.nct);var f=$("<a/>",{href:"http://www.clinicaltrials.gov/ct2/show/"+e.nct,target:"_blank"});f.addClass("supplement");f.text("Â» ClinicalTrials.gov");o.append(a);o.append(f);o.append(u);console.log("REASON:",this.reason);if(this.reason){o.append("<tt>REASON: "+this.reason+"</tt>");i.append(o)}else r.append(o)}else console.error(e,t,s)})}}function _showTrialStatus(e){$("#trials").empty().text(e)}function text2html(e){if(!e)return"";var t=e.replace(/(^\s+)|(\s+$)/g,"");t=t.replace(/(\r\n|\n)/g,"<br />");return t}function compareMedByNameASC(e,t){return"sp:drugName"in e?"dcterms:title"in e["sp:drugName"]?"sp:drugName"in t?"dcterms:title"in t["sp:drugName"]?e["sp:drugName"]["dcterms:title"]<t["sp:drugName"]["dcterms:title"]?-1:e["sp:drugName"]["dcterms:title"]>t["sp:drugName"]["dcterms:title"]?1:0:-1:-1:1:1}function compareProblemByNameASC(e,t){return"sp:problemName"in e?"dcterms:title"in e["sp:problemName"]?"sp:problemName"in t?"dcterms:title"in t["sp:problemName"]?e["sp:problemName"]["dcterms:title"]<t["sp:problemName"]["dcterms:title"]?-1:e["sp:problemName"]["dcterms:title"]>t["sp:problemName"]["dcterms:title"]?1:0:-1:-1:1:1}function compareByDateDESC(e,t){return"date"in e?"date"in t?parseInt(e.date)<parseInt(t.date)?1:parseInt(e.date)>parseInt(t.date)?-1:0:-1:1}var _ruleCtrl=null,_reportCtrl=null,_globals={},_trialSearchInterval=null;Array.prototype.contains=function(e){return this.indexOf(e)>=0};Array.prototype.indexOf=function(e){for(var t=0;t<this.length;t++)if(this[t]==e)return t;return-1};window.console||function(){var e=["log","debug","info","warn","error","assert","dir","dirxml","group","groupEnd","time","timeEnd","count","trace","profile","profileEnd"],t=e.length;window.console={};for(var n=0;n<t;n++)window.console[e[n]]=function(){}}();