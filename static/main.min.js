function initApp(){window!=window.top&&$("#back_to_patient").hide();loadDemographics();loadProblemList()}function loadDemographics(){$.ajax({url:"demographics",dataType:"json"}).always(function(e,t,n){var r="success"==t?e:"parsererror"==t?{}:null,i={};r?i=r:console.warn("No good response for demographics",e,n);$("#patient_overview").html("templates/patient_demographics.ejs",{demo:i})})}function sortChildren(e,t,n){var r=e.children(t).get();r.sort(n);$.each(r,function(t,n){e.append(n)})}function text2html(e){if(!e)return"";var t=e.replace(/(^\s+)|(\s+$)/g,"");t=t.replace(/(\r\n|\n)/g,"<br />");return t}function newUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})}function compareMedByNameASC(e,t){return"sp:drugName"in e?"dcterms:title"in e["sp:drugName"]?"sp:drugName"in t?"dcterms:title"in t["sp:drugName"]?e["sp:drugName"]["dcterms:title"]<t["sp:drugName"]["dcterms:title"]?-1:e["sp:drugName"]["dcterms:title"]>t["sp:drugName"]["dcterms:title"]?1:0:-1:-1:1:1}function compareProblemByNameASC(e,t){return"sp:problemName"in e?"dcterms:title"in e["sp:problemName"]?"sp:problemName"in t?"dcterms:title"in t["sp:problemName"]?e["sp:problemName"]["dcterms:title"]<t["sp:problemName"]["dcterms:title"]?-1:e["sp:problemName"]["dcterms:title"]>t["sp:problemName"]["dcterms:title"]?1:0:-1:-1:1:1}function compareByDateDESC(e,t){return"date"in e?"date"in t?parseInt(e.date)<parseInt(t.date)?1:parseInt(e.date)>parseInt(t.date)?-1:0:-1:1}function initMap(){if(g_map)return;var e={zoom:4,center:new google.maps.LatLng(38.5,-96.5),mapTypeId:google.maps.MapTypeId.ROADMAP};g_map=new google.maps.Map($("#g_map").get(0),e);g_patient_location&&zoomToPatient()}function showMap(){var e=Math.max(300,Math.round($(window).height()*.4));$("#g_map").css("height",e+"px").show();g_map||initMap()}function hideMap(){$("#g_map").hide();unhighlightPin()}function locatePatient(e,t){if(!e){console.warn("Cannot locate patient, no address given");g_patient_location=null;t&&t(!1,null)}geocodeAddress(e,function(e,n){g_patient_location=n;g_map&&n&&zoomToPatient();t&&t(e,n)})}function geocodeAddress(e,t){if(!e){console.error("No address given, cannot geo-code");t&&t(!1,null);return}g_geocoder||(g_geocoder=new google.maps.Geocoder);g_geocoder.geocode({address:e},function(n,r){var i=null;google.maps.GeocoderStatus.OK==r?i=n[0].geometry.location:google.maps.GeocoderStatus.ZERO_RESULTS?alert('The address "'+e+'" could not be located.'):console.error("Geocode failed: "+r);t&&t(i!=null,i)})}function addPinToMap(e,t,n,r,i,s){if(!e||!t){console.error("I need lat and long to place a pin");return}var o=new google.maps.MarkerImage("http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=%E2%80%A2"+(r?"|"+r:""),new google.maps.Size(21,34),new google.maps.Point(0,0),new google.maps.Point(10,34)),u=new google.maps.Marker({map:g_map,position:new google.maps.LatLng(e,t),title:n,icon:o,animation:i?google.maps.Animation.DROP:null});g_pins.push(u);s&&google.maps.event.addListener(u,"click",s);return u}function highlightPin(e){if(!e){console.error("I need a pin to highlight");return}g_highlighted_pin&&g_highlighted_pin.setAnimation();e.setAnimation(google.maps.Animation.BOUNCE);g_highlighted_pin=e}function unhighlightPin(){if(g_highlighted_pin){g_highlighted_pin.setAnimation();g_highlighted_pin=null}}function zoomToPins(e){if(!g_map||!$("#g_map").is(":visible"))return;if(!e||e<1)e=5;var t=[];g_patient_location&&t.push(g_patient_location);if(g_pins.length>0)if(!g_patient_location)for(var n=0;n<g_pins.length;n++)t.push(g_pins[n].getPosition());else{var r=[];for(var n=0;n<g_pins.length;n++){var i=g_pins[n].getPosition(),s=kmDistanceBetweenLocations(g_patient_location,i);r.push([i,s])}r.sort(function(e,t){return e[1]-t[1]});for(var n=0;n<Math.min(r.length,e);n++)t.push(r[n][0])}if(t.length<2){t.length>0&&g_map.setCenter(t[0]);g_map.setZoom(4);return}var o=new google.maps.LatLng(Math.min(t[0].lat(),t[1].lat())-1,Math.min(t[0].lng(),t[1].lng())),u=new google.maps.LatLng(Math.max(t[0].lat(),t[1].lat())+1,Math.max(t[0].lng(),t[1].lng())),a=new google.maps.LatLngBounds(o,u);if(!a){console.error("Failed to get a bounds object to zoom the map");return}for(var n=2;n<t.length;n++)a.extend(t[n]);g_map.fitBounds(a)}function clearAllPins(){for(var e=0;e<g_pins.length;e++)g_pins[e].setMap(null);g_pins=[]}function zoomToPatient(){if(!g_patient_location)return;if(!g_map){console.error("No map, cannot zoom to patient");return}g_patient_pin&&g_patient_pin.setMap(null);g_patient_pin=new google.maps.Marker({map:g_map,position:g_patient_location});g_map.setCenter(g_patient_location)}function kmDistanceBetweenLocationsLatLng(e,t,n,r){var i=6371,s=deg2rad(n-e),o=deg2rad(r-t),u=Math.sin(s/2)*Math.sin(s/2)+Math.cos(deg2rad(e))*Math.cos(deg2rad(n))*Math.sin(o/2)*Math.sin(o/2),a=2*Math.asin(Math.sqrt(u));return i*a}function kmDistanceBetweenLocations(e,t){return kmDistanceBetweenLocationsLatLng(e.lat(),e.lng(),t.lat(),t.lng())}function deg2rad(e){return e*(Math.PI/180)}function loadProblemList(){$.ajax({url:"problems",dataType:"json"}).always(function(e,t,n){var r="success"==t?e:"parsererror"==t?{}:null;if(r)$("#patient_problems").html("templates/patient_problems.ejs",{data:r,last_manual_condition:_last_manual_condition});else{$("#patient_problems").text("Could not load the problem list, see the console for details");console.warn("No good response for problems",e,n)}})}function didClickProblem(e,t){var n=$("#"+e);if(!$("#"+e).is("*")){alert("Error, see Browser console");console.error('didClickProblem("'+e+'") -- no such problem_id');return}t||!n.hasClass("active")?hideProblemsAndStartTrialSearch(e):cancelTrialSearchAndShowProblemList(e)}function hideProblemsAndStartTrialSearch(e){var t="prob_manual"==e,n=$("#"+e).find("div.problem_name").text();t&&(n=$("#manual_problem").val());if(!n){$("#manual_problem").focus();return}var r=$("#"+e);r.addClass("active");$("#problem_list").find("li").each(function(t,n){e!=n.getAttribute("id")&&$(n).slideUp("fast")});if(!t){var i=$("#cancel_trials");i.is("*")||(i=$("<button/>",{type:"button",id:"cancel_trials"}).text("Cancel"));r.prepend(i)}else{$("#manual_cancel").show();$("#manual_submit").hide()}var s=$("#refresh_trials");s.is("*")||(s=$("<button/>",{type:"button",id:"refresh_trials"}).text("Refresh"));s.click(function(t){didClickProblem(e,!0);t.stopPropagation()});r.prepend(s);var o=$("#select_female").is(":checked")?"female":"male",u=1*$("#demo_age").val();searchTrials(n,o,u,"prob_manual"==e)}function cancelTrialSearchAndShowProblemList(e){cancelTrialSearch();$("#problem_list").find("li").each(function(e,t){$(t).slideDown("fast")});$("#refresh_trials").remove();$("#cancel_trials").remove();$("#manual_cancel").hide();$("#manual_submit").show();e&&$("#"+e).removeClass("active");$("#selected_trial").empty();$("#trial_selectors").empty();$("#trials").empty();clearAllPins();hideMap();$("#g_map_toggle").hide()}function searchTrials(e,t,n,r){_trialSearchMustStop=!1;_initTrialSearch(e,t,n,r)}function cancelTrialSearch(){_showTrialStatus("Stopping...");_trialSearchMustStop=!0;if(_trialSearchInterval){window.clearInterval(_trialSearchInterval);_trialSearchInterval=null}}function _initTrialSearch(e,t,n,r){if(_trialSearchInterval){console.warn("Already searching");return}clearAllPins();$("#trial_selectors").empty();$("#trials").empty();_showTrialStatus("Starting...");$.ajax({url:"trial_runs",data:{cond:e,gender:t,age:n,remember_cond:r?!0:!1}}).always(function(e,t,n){if(_trialSearchMustStop)return;if("success"==t){_trialSearchInterval&&window.clearInterval(_trialSearchInterval);_trialSearchInterval=window.setInterval(function(){_checkTrialStatus(e)},1e3)}else{console.error(e," -- ",t," -- ",n);_showTrialStatus("Error searching for trials: "+t+", see console")}});r&&(_last_manual_condition=e)}function _checkTrialStatus(e){$.ajax({url:"trial_runs/"+e+"/progress"}).always(function(t,n,r){if(_trialSearchMustStop)return;if("success"==n)if("done"==t){window.clearInterval(_trialSearchInterval);_trialSearchInterval=null;_showTrialStatus("Retrieving results...");_getTrialResults(e)}else{if(t&&t.length>5&&t.match(/^error/i)){window.clearInterval(_trialSearchInterval);_trialSearchInterval=null}_showTrialStatus(t)}else{console.error(t,n,r);_showTrialStatus("Error checking trial status, see console");window.clearInterval(_trialSearchInterval);_trialSearchInterval=null}})}function _getTrialResults(e){$.ajax({url:"trial_runs/"+e+"/results",dataType:"json"}).always(function(t,n,r){if(_trialSearchMustStop)return;if("success"==n){_showTrialStatus("Found "+t.length+" trials, filtering by demographics...");_filterTrialsByDemographics(e)}else{console.error(t,n,r);_showTrialStatus("Error getting trial results, see console")}})}function _filterTrialsByDemographics(e){$.ajax({url:"trial_runs/"+e+"/filter/demographics",dataType:"json"}).always(function(t,n,r){if(_trialSearchMustStop)return;if("success"==n){_showTrialStatus("Filtering by problem list...");_filterTrialsByProblems(e)}else{console.error(t,n,r);_showTrialStatus("Error filtering trials (demographics), see console")}})}function _filterTrialsByProblems(e){$.ajax({url:"trial_runs/"+e+"/filter/problems",dataType:"json"}).always(function(e,t,n){if(_trialSearchMustStop)return;if("success"==t)loadTrialsAfterLocatingPatient(e);else{console.error(e,t,n);_showTrialStatus("Error filtering trials (problems), see console")}})}function loadTrialsAfterLocatingPatient(e){var t=$("#demo_location").val();if(!t){console.warn("No patient location information, loading trials without distance information");_patient_loc=null;_loadTrials(e);return}locatePatient(t,function(t,n){if(t)_patient_loc=n;else{console.warn("Failed to locate the patient");_patient_loc=null}_loadTrials(e)})}function _loadTrials(e){if(!e||e.length<1){_showTrialStatus("There are no such trials");return}_showTrialStatus("Loading "+e.length+" trial"+(1==e.length?"":"s")+"...");$("#g_map_toggle").show();var t=0,n=0,r=$("<div/>",{id:"selector_goodbad"}).addClass("trial_selector"),i=$("<div/>").addClass("trial_opt_selector"),s=$("<ul/>",{id:"selector_inv_phase"});i.append('<div class="trial_opt_header"><b>1: Trial phase</b></div>');i.append(s);var o=$("<div/>").addClass("trial_opt_selector"),u=$("<ul/>",{id:"selector_inv_type"});o.append('<div class="trial_opt_header"><b>2: Intervention types</b></div>');o.append(u);o.append('<div class="supplement">(Trials can have more than one intervention type)</div>');var a=$("<ul/>",{id:"trial_list"}).addClass("trial_list");_trialNumExpected=e.length;_trialNumDone=0;_showGoodTrials=!0;_activeTrialPhases=[];_activeInterventionTypes=[];var f={},l=[];for(var c=0;c<e.length;c++){var h=e[c],p=h[0],d=null;if(h.length>1){d=h[1];d&&n++}else t++;f[p]=d;if(0==(c+1)%_trialBatchSize||c==e.length-1){l.push(f);f={}}}for(var c=0;c<l.length;c++){var f=l[c],v=[];for(var p in f)v.push(p);if(0==v.length){console.warn("There are no studies in this batch");continue}$.ajax({url:"trials/"+v.join(":"),dataType:"json",context:{reasons:f}}).always(function(e,t,n){if(_trialSearchMustStop)return;if("success"==t){var r={},i={},o="trials"in e?e.trials:[];for(var f=0;f<o.length;f++){var l=o[f];_trialNumDone++;_trialNumDone>=_trialNumExpected?_showTrialStatus():_showTrialStatus("Loading, "+Math.round(_trialNumDone/_trialNumExpected*100)+"% done...");l.reason=this.reasons[l.nct];_geocodeTrial(l);if(!1 in l||!l.phase)l.phase="N/A";if(l.phase in r)r[l.phase]=r[l.phase]+(l.reason?0:1);else{r[l.phase]=l.reason?0:1;_activeTrialPhases.contains(l.phase)||_activeTrialPhases.push(l.phase)}var c=[];if("intervention"in l&&l.intervention){for(var h=0;h<l.intervention.length;h++)"intervention_type"in l.intervention[h]&&c.push(l.intervention[h].intervention_type);c=c.uniqueArray()}c.length<1&&(c=["N/A"]);for(var h=0;h<c.length;h++){var p=c[h];p in i?i[p]=i[p]+(l.reason?0:1):i[p]=l.reason?0:1}var d=$("<li/>").html("templates/trial_item.ejs",{trial:l});d.data("trial",l);d.data("good",!l.reason);d.data("distance",l.closest);d.data("phase",l.phase);d.data("intervention-types",c);a.append(d)}var m=$.map(s.children(),function(e){var t=$(e).data("phase");if(t in r){var n=$(e).find(".num_matches");n.text(n.text()*1+r[t])}return t});for(var g in r)if(!m.contains(g)){var y=_getOptTabListElement(g,r[g],!0,_togglePhase);y.data("phase",g);s.append(y)}sortChildren(s,"li",function(e,t){return $(e).text().toLowerCase().localeCompare($(t).text().toLowerCase())});m=$.map(u.children(),function(e){var t=$(e).data("intervention-type");if(t in i){var n=$(e).find(".num_matches");n.text(n.text()*1+i[t])}return t});for(var p in i)if(!m.contains(p)){var y=_getOptTabListElement(p,i[p],!1,_toggleInterventionType);y.data("intervention-type",p);u.append(y)}sortChildren(u,"li",function(e,t){return $(e).text().toLowerCase().localeCompare($(t).text().toLowerCase())});sortChildren(a,"li",function(e,t){return $(e).data("distance")-$(t).data("distance")})}else{_trialNumDone+=this.reasons.length;_trialNumDone>=_trialNumExpected&&_showTrialStatus();console.error("Failed loading NCTs:",v.join(", "),"obj1:",e,"obj2:",n)}})}var m=$("#trial_selectors"),g=_getOptTabElement("Potential Trials",t+" of "+e.length,!0,_toggleShowGoodTrials);g.data("is-good",!0);r.append(g);var y=_getOptTabElement("Ineligible Trials",n+" of "+e.length,!1,_toggleShowGoodTrials);y.data("is-good",!1);r.append(y);m.append(r);m.append(i);m.append(o);$("#trials").append(a)}function toggleTrialMap(){if($("#g_map").is(":visible")){hideMap();$("#g_map_toggle").text("Show Map");$("#selected_trial").empty().hide()}else{showMap();$("#g_map_toggle").text("Hide Map");if(_shouldShowPinsForTrials.length>0)for(var e=0;e<_shouldShowPinsForTrials.length;e++)_showPinsForTrial(_shouldShowPinsForTrials[e],!1);zoomToPins()}}function _geocodeTrial(e){if("closest"in e)return;if("location"in e){var t=[];for(var n=0;n<e.location.length;n++)if("geodata"in e.location[n]){if(_patient_loc){var r=kmDistanceBetweenLocationsLatLng(_patient_loc.lat(),_patient_loc.lng(),e.location[n].geodata.latitude,e.location[n].geodata.longitude);t.push(r);e.location[n].distance=r}}else console.warn("No geodata for trial location: ",e.location[n]);if(t.length>0){t.sort(function(e,t){return e-t});e.closest=t[0]}}else console.warn("No geodata for trial "+e.nct)}function _showPinsForTrial(e,t){if(!e){console.error("No trial to show pins for");return}if("location"in e)for(var n=0;n<e.location.length;n++)if("geodata"in e.location[n]){var r=e.location[n].geodata.latitude,i=e.location[n].geodata.longitude;addPinToMap(r,i,e.title,e.reason?"AA2200":"33CC22",t,function(t){highlightPin(this);showSelectedTrial(e)})}}function showSelectedTrial(e){$("#selected_trial").show().html("templates/trial_item.ejs",{trial:e}).children(":first").addClass("active");$("#selected_trial").append('<a class="dismiss_link" href="javascript:void(0);" onclick="unloadSelectedTrial()">dismiss</a>')}function unloadSelectedTrial(){$("#selected_trial").slideUp("fast",function(){$(this).empty()});unhighlightPin()}function _showTrialStatus(e){var t=$("#trial_status");if(!e){t.remove();return}if(!t.is("*")){t=$("<div/>",{id:"trial_status"});$("#trial_selectors").append(t)}t.text(e)}function _getOptTabElement(e,t,n,r){var i=$("<a/>",{href:"javascript:void(0)"});i.append($("<span/>").text(e));i.append($("<span/>").addClass("num_matches").text(t));r&&i.click(r);n&&i.addClass("active");return i}function _getOptTabListElement(e,t,n,r){var i=$("<li/>",{href:"javascript:void(0)"}),s=newUUID(),o=$("<input/>",{id:s,type:"checkbox"});i.append(o);i.append($("<label/>",{"for":s}).text(e));i.append($("<span/>").addClass("num_matches").text(t));r&&o.change(r);if(n){i.addClass("active");o.attr("checked",!0)}return i}function _toggleShowGoodTrials(e){_showGoodTrials=!_showGoodTrials;_updateShownHiddenTrials()}function _togglePhase(e){var t=$(this).parent().data("phase");if(!t){console.error("No phase supplied to _togglePhase()");return}var n=_activeTrialPhases.indexOf(t);n>=0?_activeTrialPhases.splice(n,1):_activeTrialPhases.push(t);_updateShownHiddenTrials()}function _toggleInterventionType(e){var t=$(this).parent().data("intervention-type");if(!t){console.error("No type supplied to _toggleInterventionType()");return}var n=_activeInterventionTypes.indexOf(t);n>=0?_activeInterventionTypes.splice(n,1):_activeInterventionTypes.push(t);_updateShownHiddenTrials()}function _updateShownHiddenTrials(){var e=$("#g_map").is(":visible");clearAllPins();_shouldShowPinsForTrials=[];$("#selected_trial").empty();var t={},n={};$("#trial_list").children("li").each(function(r,i){var s=$(i),o=_showGoodTrials==s.data("good");if(o){var u=s.data("phase");o=_activeTrialPhases.contains(u);u in t?t[u]++:t[u]=1}if(o){var a=s.data("intervention-types");o=_activeInterventionTypes.intersects(a);for(var f=0;f<a.length;f++)a[f]in n?n[a[f]]++:n[a[f]]=1}if(o){e?_showPinsForTrial(s.data("trial"),!s.is(":visible")):_shouldShowPinsForTrials.push(s.data("trial"));s.slideDown("fast")}else s.slideUp("fast")});window.setTimeout(zoomToPins,100);$("#selector_goodbad").children("a").each(function(e,t){var n=$(t);n.removeClass("active");_showGoodTrials==n.data("is-good")&&n.addClass("active")});$("#selector_inv_phase").children("li").each(function(e,n){var r=$(n),i=r.data("phase");r.find(".num_matches").text(i in t?t[i]:0);r.removeClass("active");_activeTrialPhases.contains(i)&&r.addClass("active")});$("#selector_inv_type").children("li").each(function(e,t){var r=$(t),i=r.data("intervention-type");r.find(".num_matches").text(i in n?n[i]:0);r.removeClass("active");_activeInterventionTypes.contains(i)&&r.addClass("active")})}var _ruleCtrl=null,_reportCtrl=null;Array.prototype.contains=function(e){return this.indexOf(e)>=0};Array.prototype.indexOf=function(e){for(var t=0;t<this.length;t++)if(this[t]==e)return t;return-1};Array.prototype.uniqueArray=function(){var e={},t=[];for(var n=0,r=this.length;n<r;++n){if(e.hasOwnProperty(this[n]))continue;t.push(this[n]);e[this[n]]=1}return t};Array.prototype.intersects=function(e){for(var t=0;t<this.length;t++)for(var n=0;n<e.length;n++)if(this[t]===e[n])return!0;return!1};window.console||function(){var e=["log","debug","info","warn","error","assert","dir","dirxml","group","groupEnd","time","timeEnd","count","trace","profile","profileEnd"],t=e.length;window.console={};for(var n=0;n<t;n++)window.console[e[n]]=function(){}}();var g_map=null,g_geocoder=null,g_pins=[],g_highlighted_pin=null,g_patient_pin=null,g_patient_location=null,_patient_loc=null,_trialSearchInterval=null,_trialSearchMustStop=!1,_trialBatchSize=10,_trialNumExpected=0,_trialNumDone=0,_showGoodTrials=!0,_activeTrialPhases=[],_activeInterventionTypes=[],_shouldShowPinsForTrials=[];